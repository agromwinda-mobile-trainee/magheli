// === RÃ¨gles pour le stock (CORRIGÃ‰ES) ===

match /stock/{productId} {

  allow read: if request.auth != null;

  // stock doit Ãªtre crÃ©Ã© par l'admin depuis la console
  allow create: if isAuth() && (isAdmin() || isManager());

  //  Seul un caissier peut dÃ©duire le stock
  allow update: if isCashier()              // rÃ´le caisse obligatoire
                && isSameActivity()           // mÃªme activitÃ© (CORRIGÃ‰ : compare par nom)
                && isStockDecreaseOnly()     // la quantitÃ© doit baisser
                && notGoingNegative();       // impossible d'aller sous 0

  // ðŸ”¥ EmpÃªcher suppression :
  allow delete: if false;
}

// ============================
//      FONCTIONS COMMUNES
// ============================

// L'utilisateur ne peut toucher que le stock de sa propre activitÃ©
// CORRIGÃ‰ : Compare activityName (user) avec activity (stock) au lieu de comparer les IDs
function isSameActivity() {
  let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
  let currentStock = resource.data;
  // Comparer le nom de l'activitÃ© au lieu de l'ID
  return user.activityName == currentStock.activity;
}

// ðŸ”¥ VÃ©rifie que la mise Ã  jour DIMINUE la quantitÃ©
function isStockDecreaseOnly() {
  return request.resource.data.keys().hasOnly(["quantity", "updatedAt"])
         && request.resource.data.quantity < resource.data.quantity;
}

// ðŸ”¥ VÃ©rifie que la quantitÃ© finale ne devient pas nÃ©gative
function notGoingNegative() {
  return request.resource.data.quantity >= 0;
}



