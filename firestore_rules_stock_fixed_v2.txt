// === RÃ¨gles pour le stock (VERSION CORRIGÃ‰E V2) ===
// Cette version gÃ¨re les cas oÃ¹ activityName pourrait Ãªtre null ou ne pas exister

match /stock/{productId} {

  allow read: if request.auth != null;

  // stock doit Ãªtre crÃ©Ã© par l'admin depuis la console
  allow create: if isAuth() && (isAdmin() || isManager());

  //  Seul un caissier peut dÃ©duire le stock
  allow update: if isCashier()              // rÃ´le caisse obligatoire
                && isSameActivity()         // mÃªme activitÃ© (compare par nom)
                && isStockDecreaseOnly()    // la quantitÃ© doit baisser
                && notGoingNegative();      // impossible d'aller sous 0

  // ðŸ”¥ EmpÃªcher suppression :
  allow delete: if false;
}

// ============================
//      FONCTIONS COMMUNES
// ============================

// L'utilisateur ne peut toucher que le stock de sa propre activitÃ©
// CORRIGÃ‰ : Compare activityName (user) avec activity (stock)
// GÃ¨re le cas oÃ¹ activityName pourrait Ãªtre null ou ne pas exister
function isSameActivity() {
  let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
  let currentStock = resource.data;
  
  // VÃ©rifier que l'utilisateur a un activityName
  if (!("activityName" in user) || user.activityName == null) {
    return false;
  }
  
  // VÃ©rifier que le stock a un activity
  if (!("activity" in currentStock) || currentStock.activity == null) {
    return false;
  }
  
  // Comparer le nom de l'activitÃ©
  return user.activityName == currentStock.activity;
}

// ðŸ”¥ VÃ©rifie que la mise Ã  jour DIMINUE la quantitÃ©
function isStockDecreaseOnly() {
  return request.resource.data.keys().hasOnly(["quantity", "updatedAt"])
         && request.resource.data.quantity < resource.data.quantity;
}

// ðŸ”¥ VÃ©rifie que la quantitÃ© finale ne devient pas nÃ©gative
function notGoingNegative() {
  return request.resource.data.quantity >= 0;
}




