// === R√®gles compl√®tes pour le stock (VERSION FINALE CORRIG√âE) ===
// IMPORTANT: Les fonctions doivent √™tre d√©finies AVANT les r√®gles match
// CORRECTION : La fonction isStockDecreaseOnly() v√©rifie maintenant que seuls quantity et updatedAt sont modifi√©s
// (et non que le document ne contient que ces champs)

// ============================
//      FONCTIONS HELPER DE BASE
// ============================

function isAuth() {
  return request.auth != null;
}

function isAdmin() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

function isManager() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager';
}

function isCashier() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'cashier';
}

// ============================
//      FONCTIONS SP√âCIFIQUES AU STOCK
// ============================

// L'utilisateur ne peut toucher que le stock de sa propre activit√©
// CORRIG√â : Compare activityName (user) avec activity (stock)
// Syntaxe Firestore : utilisation d'op√©rateurs logiques au lieu de if
function isSameActivity() {
  let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
  let currentStock = resource.data;
  
  // V√©rifier que l'utilisateur a un activityName ET que le stock a un activity
  // Utilisation d'op√©rateurs logiques au lieu de if (syntaxe Firestore)
  return ("activityName" in user) 
         && user.activityName != null
         && ("activity" in currentStock)
         && currentStock.activity != null
         && user.activityName == currentStock.activity;
}

// üî• V√©rifie que la mise √† jour DIMINUE la quantit√©
// CORRIG√â : V√©rifie que seuls quantity et updatedAt sont modifi√©s (pas que le document ne contient que ces champs)
function isStockDecreaseOnly() {
  // V√©rifier que la quantit√© diminue
  let quantityDecreases = request.resource.data.quantity < resource.data.quantity;
  
  // V√©rifier que les autres champs ne sont pas modifi√©s
  // (name, activity, unit, etc. doivent rester identiques)
  let nameUnchanged = (!("name" in request.resource.data) && !("name" in resource.data)) 
                      || (request.resource.data.name == resource.data.name);
  let activityUnchanged = (!("activity" in request.resource.data) && !("activity" in resource.data))
                          || (request.resource.data.activity == resource.data.activity);
  
  // updatedAt peut √™tre modifi√© (timestamp)
  // quantity doit √™tre modifi√© et diminuer (v√©rifi√© ci-dessus)
  
  return quantityDecreases && nameUnchanged && activityUnchanged;
}

// üî• V√©rifie que la quantit√© finale ne devient pas n√©gative
function notGoingNegative() {
  return request.resource.data.quantity >= 0;
}

// ============================
//      R√àGLES MATCH
// ============================

match /stock/{productId} {

  allow read: if request.auth != null;

  // stock doit √™tre cr√©√© par l'admin depuis la console
  allow create: if isAuth() && (isAdmin() || isManager());

  //  Seul un caissier ou manager peut d√©duire le stock
  // ‚úÖ CORRECTION : Ajout de parenth√®ses pour corriger la priorit√© des op√©rateurs
  allow update: if (isManager() || isCashier())
                && isStockDecreaseOnly()    // la quantit√© doit baisser
                && notGoingNegative()       // impossible d'aller sous 0
                && (isManager() || isSameActivity()); // Manager peut tout modifier, caissier seulement son activit√©

  // üî• Emp√™cher suppression :
  allow delete: if false;
}


