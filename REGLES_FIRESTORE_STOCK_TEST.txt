// === R√®gles pour le stock (VERSION TEST SIMPLIFI√âE) ===
// Utilisez cette version pour tester et identifier le probl√®me
// IMPORTANT: Les fonctions doivent √™tre d√©finies AVANT les r√®gles match

// ============================
//      FONCTIONS HELPER DE BASE
// ============================

function isAuth() {
  return request.auth != null;
}

function isAdmin() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

function isManager() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager';
}

function isCashier() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'cashier';
}

// ============================
//      FONCTIONS SP√âCIFIQUES AU STOCK
// ============================

// Version simplifi√©e pour test - sans v√©rification d'activit√©
function isSameActivity() {
  let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
  let currentStock = resource.data;
  
  // Version simplifi√©e : retourne true si les deux existent et correspondent
  return ("activityName" in user) 
         && user.activityName != null
         && ("activity" in currentStock)
         && currentStock.activity != null
         && user.activityName == currentStock.activity;
}

function isStockDecreaseOnly() {
  return request.resource.data.keys().hasOnly(["quantity", "updatedAt"])
         && request.resource.data.quantity < resource.data.quantity;
}

function notGoingNegative() {
  return request.resource.data.quantity >= 0;
}

// ============================
//      R√àGLES MATCH
// ============================

match /stock/{productId} {

  allow read: if request.auth != null;

  // stock doit √™tre cr√©√© par l'admin depuis la console
  allow create: if isAuth() && (isAdmin() || isManager());

  // VERSION TEST 1 : Simplifi√©e au maximum
  // D√©commentez cette ligne et commentez les autres pour tester
  // allow update: if isAuth() && isCashier();

  // VERSION TEST 2 : Avec v√©rification de diminution
  // allow update: if isAuth() && isCashier() && isStockDecreaseOnly() && notGoingNegative();

  // VERSION FINALE : Avec toutes les v√©rifications
  allow update: if (isManager() || isCashier())
                && isStockDecreaseOnly()
                && notGoingNegative()
                && (isManager() || isSameActivity());

  // üî• Emp√™cher suppression :
  allow delete: if false;
}



